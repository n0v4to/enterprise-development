# Разработка корпоративных приложений
### Цель
Реализация проекта сервисно-ориентированного приложения.

# Задание "Пункт проката автомобилей"
# Лабораторная работа №1 — «Классы»

В рамках лабораторной работы была разработана доменная модель системы управления пунктом проката автомобилей.
Также реализован комплекс модульных тестов для проверки функциональности.
В системе хранятся данные об автомобилях, клиентах и операциях аренды.

Каждый автомобиль имеет государственный номер, цвет и принадлежит определённому поколению модели.
Поколение модели включает справочную информацию: год выпуска, объём двигателя, тип коробки передач и стоимость аренды в час.
Модель автомобиля содержит сведения о названии, типе привода, количестве посадочных мест, типе кузова и классе автомобиля.
Клиенты характеризуются ФИО, номером водительского удостоверения и датой рождения.
Для каждой аренды фиксируется время начала и продолжительность в часах.

### Классы

Model — описывает модель автомобиля, включает тип привода, количество посадочных мест, тип кузова и класс автомобиля.
ModelGeneration — представляет поколение модели, включает год выпуска, объём двигателя, тип коробки передач и почасовую стоимость аренды.
Car — представляет конкретный автомобиль, содержит государственный номер, цвет и ссылку на поколение модели.
Client — содержит информацию о клиенте: ФИО, номер водительского удостоверения и дату рождения.
Rental — описывает операцию аренды автомобиля, содержит ссылки на клиента и автомобиль, время начала, продолжительность и вычисляемую общую стоимость.

### Тесты
Модульные тесты реализованы с использованием xUnit и фикстуры DataSeedFixture для подготовки тестовых данных.
Проверяются следующие сценарии:
- ClientsByModel — получение списка клиентов, арендовавших автомобили указанной модели, с упорядочиванием по ФИО.
- CarsInUse — выборка автомобилей, находящихся в аренде на текущий момент.
- Top5MostRentedCars — определение топ-5 наиболее часто арендуемых моделей автомобилей.
- RentalsPerCar — подсчёт количества аренд для каждого автомобиля.
- Top5ClientsByTotalCost — определение топ-5 клиентов по суммарной стоимости аренд.

---

# Лабораторные работы №2 и №3 — «Сервер» и «ORM»

В рамках лабораторных работ реализовано серверное приложение REST API с подключением к базе данных MongoDB.
Хранение данных выполнено сразу с использованием MongoDB.

## Структура решения

```
CarRental.sln
├── CarRental.AppHost/              — .NET Aspire Host (оркестратор)
├── CarRental.ServiceDefaults/      — общие настройки Aspire
├── CarRental.Api.Host/             — REST API (ASP.NET Core WebAPI)
├── CarRental.Application/          — сервисы бизнес-логики
├── CarRental.Application.Contracts/— DTO и интерфейсы сервисов
├── CarRental.Domain/               — доменные модели и интерфейс репозитория
├── CarRental.Infrastructure.EfCore/— реализация репозиториев (EF Core и MongoDB)
└── CarRental.Tests/                — модульные тесты (xUnit)
```

## Архитектура

Приложение построено по принципу слоистой архитектуры:

```
┌─────────────────────────────────────┐
│         CarRental.Api.Host          │  ← REST Controllers
├─────────────────────────────────────┤
│       CarRental.Application         │  ← Business Services
├─────────────────────────────────────┤
│   CarRental.Application.Contracts   │  ← DTOs & Interfaces
├─────────────────────────────────────┤
│         CarRental.Domain            │  ← Domain Models & IRepository
├─────────────────────────────────────┤
│   CarRental.Infrastructure.EfCore   │  ← Repository Implementations
└─────────────────────────────────────┘
```

## API Endpoints

### CRUD-операции

Для каждой сущности реализованы стандартные CRUD-операции:

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/{entity}` | Получить все записи |
| GET | `/api/{entity}/{id}` | Получить запись по ID |
| POST | `/api/{entity}` | Создать новую запись |
| PUT | `/api/{entity}/{id}` | Обновить запись |
| DELETE | `/api/{entity}/{id}` | Удалить запись |

**Сущности:** `cars`, `clients`, `models`, `model-generations`, `rentals`

### Аналитические запросы

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/analytics/clients-by-model/{modelId}` | Клиенты, арендовавшие автомобили указанной модели |
| GET | `/api/analytics/currently-rented` | Автомобили, находящиеся в аренде на текущий момент |
| GET | `/api/analytics/top-rented?count={n}` | Топ-N наиболее часто арендуемых автомобилей |
| GET | `/api/analytics/rental-count-per-car` | Количество прокатов для каждого автомобиля |
| GET | `/api/analytics/top-clients?count={n}` | Топ-N клиентов по сумме потраченных средств |

## Оркестрация (.NET Aspire)

Настроен оркестратор .NET Aspire для автоматического запуска:
- Контейнера MongoDB
- API-сервера с подключением к базе данных

---

# Лабораторная работа №4 — «Брокер сообщений»

В рамках лабораторной работы реализована интеграция с брокером сообщений RabbitMQ для асинхронной генерации контрактов аренды.

## Структура решения (дополнение)

```
CarRental.sln
├── ...
├── CarRental.Generator.RabbitMq.Host/  — Генератор контрактов + Producer (ASP.NET Core WebAPI)
└── CarRental.Infrastructure.RabbitMq/  — Consumer для обработки сообщений (BackgroundService)
```

## Компоненты

### CarRental.Generator.RabbitMq.Host (Генератор + Producer)

Отдельное приложение без референсов к серверным проектам.


- `GeneratorController` - API-контроллер для запуска генерации
- `RentalGenerator` - Генерация `RentalCreateUpdateDto` с помощью Bogus
- `RabbitMqProducer` - Публикация сообщений в очередь RabbitMQ
- `GeneratorOptions` - Настройки генерации (ClientId: 1-20, CarId: 1-20, и т.д.)
- `RabbitMqOptions` - Настройки подключения к RabbitMQ

### CarRental.Infrastructure.RabbitMq (Consumer)

- `RabbitMqConsumer` - `BackgroundService` для получения сообщений из очереди
- `RabbitMqOptions` - Настройки подключения и ретраев

## Обработка ошибок

- **Polly retries** — экспоненциальный backoff при подключении к RabbitMQ
- **KeyNotFoundException** — логирование и пропуск при отсутствии связанных сущностей (Client/Car)
- Настраиваемое количество попыток и задержка через `appsettings.json`

## Оркестрация (.NET Aspire)

Обновлённая конфигурация AppHost:
- MongoDB контейнер
- RabbitMQ с Management Plugin (веб-интерфейс)
- API-сервер с подключением к MongoDB и RabbitMQ
- Генератор контрактов с подключением к RabbitMQ